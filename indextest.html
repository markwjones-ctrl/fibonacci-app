<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fibonacci Flow</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: black;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  color: #333333;
  font-size: 2em;
  transition: background-color 1s linear;
  overflow: hidden;
}

/* Center dot */
#dot {
  position: absolute;
  width: 50px;
  height: 50px;
  background: white;
  border-radius: 50%;
  opacity: 0;
}
</style>
</head>

<body>

<div id="display">5:00</div>
<div id="dot"></div>

<script>
const display = document.getElementById("display");
const dot = document.getElementById("dot");

let paused = false;
let activeDotInterval;
let activeTimer;

document.body.addEventListener("click", () => paused = !paused);

// Fibonacci scaling
const fibonacci = [1,1,2,3,5,8,13];
const total = fibonacci.reduce((a,b)=>a+b,0);
const scale = 13 / total;
const segments = fibonacci.map(n => n * scale * 60);

// Colours
const colors = [
  '#550000',
  '#553000',
  '#555500',
  '#003300',
  '#000055',
  '#220044',
  '#330033'
];

// True pulse intervals (milliseconds)
const pulseIntervals = [
  3000,
  2000,
  1000,
  1500,
  500,
  333,
  250
];

function startDot(interval) {
  clearInterval(activeDotInterval);
  activeDotInterval = setInterval(() => {
    if (paused) return;
    dot.style.opacity = 1;
    setTimeout(() => dot.style.opacity = 0, 200);
  }, interval);
}

function stopDot() {
  clearInterval(activeDotInterval);
  dot.style.opacity = 0;
}

function pulseToBlack(color, seconds, done) {
  stopDot();
  let count = 0;

  activeTimer = setInterval(() => {
    if (!paused) {
      document.body.style.backgroundColor =
        count % 2 === 0 ? "black" : color;
      count++;
      if (count >= seconds) {
        clearInterval(activeTimer);
        done();
      }
    }
  }, 1000);
}

function runFibonacci() {
  display.textContent = "";
  let i = 0;

  function nextSegment() {
    if (i >= segments.length) return;

    const duration = segments[i];
    const color = colors[i];

    document.body.style.backgroundColor = color;
    startDot(pulseIntervals[i]);

    const warningTime = (i === segments.length - 1) ? 30 : 10;

    setTimeout(() => {
      pulseToBlack(color, warningTime, () => {
        i++;
        nextSegment();
      });
    }, (duration - warningTime) * 1000);
  }

  nextSegment();
}

function startPreFade() {
  let count = 0;

  activeTimer = setInterval(() => {
    if (!paused) {
      document.body.style.backgroundColor =
        count % 2 === 0 ? "black" : "#444";
      count++;
      if (count >= 10) {
        clearInterval(activeTimer);
        runFibonacci();
      }
    }
  }, 1000);
}

function startCountdown() {
  let seconds = 300;

  activeTimer = setInterval(() => {
    if (!paused) {
      let m = Math.floor(seconds / 60);
      let s = seconds % 60;
      display.textContent =
        m + ":" + s.toString().padStart(2, "0");
      seconds--;
      if (seconds < 0) {
        clearInterval(activeTimer);
        startPreFade();
      }
    }
  }, 1000);
}

startCountdown();
</script>

</body>
</html>
